<?php
/**
 * GiaPhuGroup Co., Ltd.
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the GiaPhuGroup.com license that is
 * available through the world-wide-web at this URL:
 * https://www.giaphugroup.com/LICENSE.txt
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade this extension to newer
 * version in the future.
 *
 * @category    PHPCuong
 * @package     PHPCuong_CustomerAccount
 * @copyright   Copyright (c) 2018-2019 GiaPhuGroup Co., Ltd. All rights reserved. (http://www.giaphugroup.com/)
 * @license     https://www.giaphugroup.com/LICENSE.txt
 */
 /** @var \PHPCuong\CustomerAccount\Block\Form\Register $block */


?>

<?php if (!$block->customerIsAlreadyLoggedIn() && $block->getRegistration()->isAllowed()): ?>
    <style>
        .customer-popup-register {
            display: none;
        }
    </style>
    <div id="customer-popup-register" class="customer-popup-register">
        <div class="customer-account-wrapper">
        <form class="form-create-account" action="<?php /* @escapeNotVerified */ echo $block->getPostActionUrl() ?>" method="post" id="customer-popup-form-register" enctype="multipart/form-data" autocomplete="off" data-mage-init='{"validation":{}}'>
            <h2 class="account-heading"><?php echo __('Sign up'); ?></h2>
            <?php echo $block->getBlockHtml('formkey'); ?>
            <input type="hidden" name="redirect_url" value="<?php echo $this->getUrl('*/*/*', ['_current' => true, '_use_rewrite' => true]); ?>" />
            <div class="messages"></div>
            <!-- <p><?php /* @escapeNotVerified */ echo __('Creating an account has many benefits: check out faster, keep more than one address, track orders and more.') ?></p> -->
            <fieldset class="fieldset create info">
                <!-- <legend class="legend"><span><?php /* @escapeNotVerified */ echo __('Personal Information') ?></span></legend><br> -->
                <?php echo $block->getLayout()->createBlock('Magento\Customer\Block\Widget\Name')->setObject($block->getFormData())->setForceUseCustomerAttributes(true)->toHtml() ?>
               <!--OTP MODULE-->
  <?php
   
        $smsProfileHelper = $this->helper('Magedelight\SMSProfile\Helper\Data');
        $validateClass = '';
        $required = 0;
        $enableModule = $smsProfileHelper->getModuleStatus();
        if ($enableModule) {
            $required = $smsProfileHelper->getSmsProfilePhoneRequiredOnSignUp();
            $validateClass = $smsProfileHelper->getSmsProfilePhoneValidationClass();
            $sendOtpUrl = $this->getUrl('smsprofile/otp/send');
            $verifyOtpUrl = $this->getUrl('smsprofile/otp/verify');
            echo "<input type='hidden' class='sendUrl' value='" . $sendOtpUrl . "'/>";
            echo "<input type='hidden' class='verifyUrl' value='" . $verifyOtpUrl . "'/>";
            echo "<input type='hidden' class='signupOtpValidation' name='signupOtpValidation' value='0'/>";
        }
        ?>
        <div class="field field-name-customer_mobile <?php if ($required) {
            echo 'required';
        } ?>">
         
            <div class="control">
                <input name="country-code" type="tel" id="country-code" value="" type="hidden">
                <input type="number" maxlength="10" id="customer_mobile" data-validate='{"required":true}' placeholder="Phone Number" name="customer_mobile" value="" title="customer_mobile"
                oninput="javascript: if (this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);"
                class="input-text <?php if ($required) {
                           echo 'required-entry ';
                       } ?> <?php echo $validateClass; ?>" <?php if ($required) {
                    echo 'data-validate="{required:true}"';
                } ?> autocomplete="off" aria-required="true" type="text" data-mage-init='{"validation":{}}'>
            </div>
            <div id="mobileresponse"></div>
        </div>


                <!--OTP END-->
                <?php if ($block->isNewsletterEnabled()): ?>
                    <!-- <div class="field choice newsletter">
                        <input type="checkbox" name="is_subscribed" title="<?php /* @escapeNotVerified */ echo __('Sign Up for Newsletter') ?>" value="1" id="popup-is_subscribed" class="checkbox">
                        <label for="is_subscribed" class="label"><span><?php /* @escapeNotVerified */ echo __('Sign Up for Newsletter') ?></span></label>
                    </div> -->
                <?php endif ?>
            </fieldset>
            <fieldset class="fieldset create account" data-hasrequired="<?php /* @escapeNotVerified */ echo __('* Required Fields') ?>">
                <!-- <legend class="legend"><span><?php /* @escapeNotVerified */ echo __('Sign-in Information') ?></span></legend><br> -->
                <div class="field required cust-email-address">
                    <!-- <label for="popup-email_address" class="label"><span><?php /* @escapeNotVerified */ echo __('Email') ?></span></label> -->
                    <div class="control">
                        <input type="email" name="email" placeholder="Email" autocomplete="email" id="popup-email_address" value="" title="<?php /* @escapeNotVerified */ echo __('Email') ?>" class="input-text" data-validate="{required:true, 'validate-email':true}">
                        <div id="emailresponse"></div>
                    </div>
                </div>
          <div class="field required">
                <!-- <label for="postcode" class="label"><span><?php /* @escapeNotVerified */ echo __('Postcode') ?></span></label> -->
                <div class="control">
                    <input type="number" maxlength="6" name="postcode" placeholder="Current residence PIN code"
                           value="<?= $block->escapeHtmlAttr($block->getFormData()->getPostcode()) ?>"
                           title="<?php /* @escapeNotVerified */ echo __('Postcode') ?>" id="zip"
                           oninput="javascript: if (this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);"
                           class="input-text validate-zip-international <?= $block->escapeHtmlAttr($this->helper('Magento\Customer\Helper\Address')->getAttributeValidationClass('postcode')) ?>" data-validate='{"required":true}'>
                </div>
            </div>
            </fieldset>
            <div class="actions-toolbar">
                <div class="primary">
                    <button type="submit" name="submit" id="submit" class="action submit primary" title="<?php /* @escapeNotVerified */ echo __('Sign Up') ?>"><span><?php /* @escapeNotVerified */ echo __('Sign Up') ?></span></button>
                </div>
                <div class="or-another-selection">
                    <p><?php echo __('or login via'); ?></p>
                    <?php echo $this->getLayout()->createBlock("Mageplaza\SocialLogin\Block\Popup\Social")->setTemplate("Mageplaza_SocialLogin::form/social.phtml")->toHtml() ?>
                </div>
                <div class="secondary">
                    <span><?php /* @escapeNotVerified */ echo __("Already have an account?") ?></span>
                    <a class="action remind" href="<?php /* @escapeNotVerified */ echo $block->getBackUrl() ?>" id="customer-popup-sign-in"><span><?php /* @escapeNotVerified */ echo __('Log In') ?></span></a>
                    <span><?php /* @escapeNotVerified */ echo __("here") ?></span>
                </div>
                <div class="other-links">
                    <a href="<?= $this->getUrl('terms') ?>"><?php echo __('Terms & Conditions'); ?></a> |
                    <a href="<?= $this->getUrl('privacy-policy') ?>"><?php echo __('Privacy Policy'); ?></a>
                </div>
            </div>
        </form>
        <div id="popup-mpdal" style="display:none;">
            <?php  include ($block->getTemplateFile('Codilar_TokenAPI::popup.phtml')) ?>
        </div>  
        <div class="right-img-box">
            <img src='<?php echo $this->getViewFileUrl('images/createbox.png'); ?>' alt="logo" />
        </div>
    </div>
        <script type="text/x-magento-init">
            {
                "#customer-popup-register": {
                    "PHPCuong_CustomerAccount/js/action/customer-authentication-popup": {
                        "popupTitle": "<?php /* @escapeNotVerified */ echo __('Create an Account'); ?>",
                        "innerWidth": "800"
                    }
                }
            }
        </script>
        <script type="text/javascript">
require(['jquery'], function($){
$(document).ready(function()
{
$('#customer_mobile').on('change', function () 
 {
   var mobileValue = jQuery("input[name='customer_mobile']").val();
   
    jQuery.ajax({
                url: '/user/customer/index',
                // url: "getAjaxUrl()",
                data: {mobile:mobileValue},
                type: "POST",
                dataType: "json",
                complete: function(mobileResult) {
                    $("#mobileresponse").html(""); 
                    $("#mobileresponse").append(mobileResult.responseJSON);
                    if ($('#mobileresponse').is(':empty')){
                        console.log('empty');
                    } else {
                        $('button#submit').prop('disabled', true);
                        $('.field.field-name-customer_mobile .control').removeClass('input-has-value');
                    }
              }
            });
});
});
});
</script>

<script type="text/javascript">
require(['jquery'], function($){
$(document).ready(function()
{ 
$('#popup-email_address').on('change', function () 
 {
    var emailValue = $("#popup-email_address").val();
   jQuery.ajax({
                url: '/user/customer/index',
                // url: "getAjaxUrl()",
                data: {email:emailValue},
                type: "POST",
                dataType: "json",
                complete: function(resultJson) {
                    $("#emailresponse").html(""); 
                    $("#emailresponse").append(resultJson.responseJSON);
                    if ($('#emailresponse').is(':empty')){
                        console.log('empty');
                    } else {
                        $('button#submit').prop('disabled', true);
                        $('.cust-email-address .control').removeClass('input-has-value');
                    }
                }
              
            });
});
});
});
</script>
    </div>
<?php endif; ?>


<script>
require(['jquery','intlTelInput'], function($) {
    if(!$('input#country-code').length <= 0) {
        // Vanilla Javascript
        var input = document.querySelector("input#country-code");
        window.intlTelInput(input,({
        // options here
        }));

        $(document).ready(function() {
            var ccode = $('.iti__selected-dial-code').text();
            console.log(ccode);
            $('.iti__flag-container').click(function() { 
            var selected_ccode = $('.iti__selected-dial-code').text();
            console.log(selected_ccode);
            var countryCode = $('.iti__selected-flag').attr('title');
            var countryCode = countryCode.replace(/[^0-9]/g,'')
            $('input#country-code').val("");
            $('input#country-code').val("+"+countryCode+" "+ $('input#country-code').val());
            });
        });
    }
});
</script>

<script>
        require(
            [
                'jquery',
                'Magento_Ui/js/modal/modal'
            ],

            function(
                $,
                modal
            ) {
                var options = {
                    type: 'popup',
                    modalClass: 'otp-popup',
                    responsive: true,
                    innerScroll: true,
                    buttons: []
                };
                if ($("#popup-mpdal").length != 0 && $("#customer-popup-register").length != 0) { 
                var popup = modal(options, $('#popup-mpdal'));

                    $("#submit").on('click',function(event) {
                    event.preventDefault();
                    var regEmail =  $("#popup-email_address").val();
                    var regPhone = $("#customer_mobile").val();
                    var regName = $("#firstname").val();
                    var regZip = $("#zip").val();
                    var selected_ccode = $('.iti__selected-dial-code').text();
                    console.log('selected country code' + selected_ccode);
                    jQuery.ajax({
                        url: '/phpcuong/customer_ajax/register',
                        // url: "getAjaxUrl()",
                        data: {
                        customer_mobile:regPhone,
                        firstname:regName,
                        email: regEmail,
                        postcode: regZip
                        },
                        type: "POST",
                        // dataType: "json",
                        success: function(response){
                        } 
                    });
                    var value = $("#customer_mobile").val();
                    var email = $("#popup-email_address").val();
                    if (selected_ccode == +91) {
                        $("#popup-mpdal").modal("openModal");
                    }
                    
                    $("#otp_mobile").prop('disabled', true);
                    $(".otp-edit").on('click',function(){
                        $("#otp_mobile").prop('disabled', false);
                    });
                    $(".resend-otp, .otp-edit-send").on('click',function(){
                        $("#set-otp").hide();
                        $("#reset-otp").show();
                    });
                    $("#otp_mobile").on('change keyup',function(){
                        var otpNum = $(this).val(); 
                        if(otpNum.length == 10) {
                            $(".otp-edit").hide();
                        }
                    });
                    
                    /*timer*/
                    var timer2 = "2:31";
                    var interval = setInterval(function() {
                    var timer = timer2.split(':');
                    //by parsing integer, I avoid all extra string processing
                    var minutes = parseInt(timer[0], 10);
                    var seconds = parseInt(timer[1], 10);
                    --seconds;
                    minutes = (seconds < 0) ? --minutes : minutes;
                    if (minutes < 0) clearInterval(interval);
                    seconds = (seconds < 0) ? 59 : seconds;
                    seconds = (seconds < 10) ? '0' + seconds : seconds;
                    //minutes = (minutes < 10) ?  minutes : minutes;
                    $('.countdown').html(minutes + ':' + seconds);
                    timer2 = minutes + ':' + seconds;
                    }, 1000);

                    $('#customer-popup-register').modal('closeModal');

                    $('#otp_mobile').val(value);
                    $('#email').val(email);
                    $('#oldphone').val(value);
                    /*$("body").bind("ajaxComplete", function(e, xhr, settings){
                        $('#send2-otp-verify').on('click',function () {
                            console.log('ajax loaded...');
                            if ($("#user-exist-error:contains('Error')").length > 0) {
                                console.log('clicked');
                                setTimeout(function () {
                                $('#customer-popup-register').modal('closeModal');
                                console.log('close');
                                }, 1000);
                            }
                        });
                    });*/
                });
            }

            }
        );
    </script>




